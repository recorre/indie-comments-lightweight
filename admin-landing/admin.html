<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indie Comments - Admin Dashboard</title>
    <link rel="stylesheet" href="css/pico.min.css">
    <style>
        :root {
            --pico-primary: #4f46e5;
            --pico-primary-hover: #4338ca;
            --pico-danger: #ef4444;
            --pico-success: #22c55e;
            --pico-font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        /* Custom styles not covered by Pico.css */
        .admin-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--pico-primary);
        }
        
        .comment-card {
            border-left: 4px solid var(--pico-secondary); /* Use Pico secondary for default border */
        }
        
        .comment-card.pending {
            border-left-color: #f59e0b; /* Keep custom pending color */
        }
        
        .comment-card.approved {
            border-left-color: var(--pico-success);
        }
        
        .comment-card.spam {
            border-left-color: var(--pico-danger);
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .comment-author {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .comment-date {
            color: var(--pico-muted-color); /* Use Pico muted color */
            font-size: 0.9rem;
        }
        
        .comment-content {
            line-height: 1.6;
        }
        
        .comment-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 600px) {
            .comment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .comment-actions {
                flex-direction: column;
            }
            
            .comment-actions button { /* Target buttons directly */
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header container" role="banner">
        <nav aria-label="Main navigation">
            <ul>
                <li><strong>Indie Comments Admin</strong></li>
            </ul>
            <ul>
                <li><a href="../">Home</a></li>
                <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <header>
            <h1>Comment Moderation</h1>
            <p>Moderate and manage comments across your site</p>
        </header>

        <section class="filters" aria-labelledby="filters-heading">
            <h2 id="filters-heading" class="sr-only">Filter Controls</h2>
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter">
                    <option value="">All Comments</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="spam">Spam</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="limitSelect">Show:</label>
                <select id="limitSelect">
                    <option value="10">10 per page</option>
                    <option value="25" selected>25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
            
            <button id="refreshBtn">Refresh</button>
        </section>

        <section class="stats" aria-labelledby="stats-heading" id="statsContainer">
            <h2 id="stats-heading" class="sr-only">Statistics Overview</h2>
            <div class="grid stats-grid">
                <article class="stat-card">
                    <h3 class="stat-number" id="pendingCount">0</h3>
                    <p>Pending</p>
                </article>
                <article class="stat-card">
                    <h3 class="stat-number" id="approvedCount">0</h3>
                    <p>Approved</p>
                </article>
                <article class="stat-card">
                    <h3 class="stat-number" id="spamCount">0</h3>
                    <p>Spam</p>
                </article>
                <article class="stat-card">
                    <h3 class="stat-number" id="totalComments">0</h3>
                    <p>Total</p>
                </article>
            </div>
        </section>

        <section id="commentsContainer" aria-live="polite" aria-labelledby="comments-heading">
            <h2 id="comments-heading" class="sr-only">Comments List</h2>
            <p role="alert" id="loadingMessage">
                Loading comments...
            </p>
            <!-- Comments will be loaded here dynamically -->
        </section>
    </main>

    <footer class="container" role="contentinfo">
        <small>Indie Comments Admin &copy; 2025</small>
    </footer>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3001/api';
        const ADMIN_API_KEY = localStorage.getItem('adminApiKey') || 'your-admin-key-here';

        // DOM Elements
        const commentsContainer = document.getElementById('commentsContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const statusFilter = document.getElementById('statusFilter');
        const limitSelect = document.getElementById('limitSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Stats elements
        const pendingCountEl = document.getElementById('pendingCount');
        const approvedCountEl = document.getElementById('approvedCount');
        const spamCountEl = document.getElementById('spamCount');
        const totalCommentsEl = document.getElementById('totalComments');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial comments
            loadComments();
            
            // Set up event listeners
            statusFilter.addEventListener('change', loadComments);
            limitSelect.addEventListener('change', loadComments);
            refreshBtn.addEventListener('click', loadComments);
            logoutBtn.addEventListener('click', logout);
        });

        // Load comments based on filters
        async function loadComments() {
            loadingMessage.style.display = 'block';
            commentsContainer.innerHTML = '';
            
            try {
                const status = statusFilter.value;
                const limit = limitSelect.value;
                
                let url = `${API_BASE_URL}/admin/comments`;
                const params = [];
                
                if (status) params.push(`status=${status}`);
                if (limit) params.push(`limit=${limit}`);
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${ADMIN_API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load comments: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                displayComments(data.data || []);
                
                // Load stats
                loadStats();
            } catch (error) {
                console.error('Error loading comments:', error);
                commentsContainer.innerHTML = `<div class="alert alert-error">Error loading comments: ${error.message}</div>`;
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        // Display comments in the UI
        function displayComments(comments) {
            if (!comments || comments.length === 0) {
                commentsContainer.innerHTML = '<p>No comments found.</p>';
                return;
            }
            
            const commentsHtml = comments.map(comment => {
                const statusClass = comment.status || 'pending';
                const formattedDate = formatDate(comment.created_at);
                
                return `
                    <article class="comment-card ${statusClass}" data-comment-id="${comment.id}">
                        <header class="comment-header">
                            <div>
                                <hgroup>
                                    <h3 class="comment-author">${escapeHtml(comment.author_name)}</h3>
                                    <p>${escapeHtml(comment.author_email || '')}</p>
                                </hgroup>
                            </div>
                            <time class="comment-date" datetime="${comment.created_at}">${formattedDate}</time>
                        </header>
                        <div class="comment-content">${formatContent(comment.message)}</div>
                        <footer class="comment-actions">
                            <button class="contrast" onclick="updateCommentStatus(${comment.id}, 'approved')">Approve</button>
                            <button class="secondary" onclick="updateCommentStatus(${comment.id}, 'rejected')">Reject</button>
                            <button class="outline" onclick="updateCommentStatus(${comment.id}, 'spam')">Mark as Spam</button>
                            ${comment.status === 'pending' ?
                                `<button class="ghost" onclick="showThread(${comment.thread_id})">View Thread</button>` :
                                ''}
                        </footer>
                    </article>
                `;
            }).join('');
            
            commentsContainer.innerHTML = commentsHtml;
        }

        // Update comment status
        async function updateCommentStatus(commentId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_API_KEY}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update comment: ${response.status} ${response.statusText}`);
                }
                
                // Log moderation action
                await logModerationAction(commentId, newStatus);
                
                // Reload comments to reflect changes
                loadComments();
            } catch (error) {
                console.error('Error updating comment status:', error);
                alert(`Error updating comment: ${error.message}`);
            }
        }

        // Log moderation action
        async function logModerationAction(commentId, action) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/moderation-log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_API_KEY}`
                    },
                    body: JSON.stringify({
                        comment_id: commentId,
                        moderator_id: 1, // In a real app, this would come from session
                        action: action,
                        reason: action // Could be expanded to include specific reasons
                    })
                });
                
                if (!response.ok) {
                    console.warn('Failed to log moderation action:', response.status);
                }
            } catch (error) {
                console.warn('Error logging moderation action:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                // For simplicity, we'll make separate requests for each stat
                // In a real app, you might have a dedicated stats endpoint
                const response = await fetch(`${API_BASE_URL}/admin/comments?limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${ADMIN_API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load stats: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const comments = data.data || [];
                
                // Calculate stats
                const stats = comments.reduce((acc, comment) => {
                    acc.total++;
                    acc[comment.status] = (acc[comment.status] || 0) + 1;
                    return acc;
                }, { total: 0, pending: 0, approved: 0, rejected: 0, spam: 0 });
                
                // Update DOM
                pendingCountEl.textContent = stats.pending;
                approvedCountEl.textContent = stats.approved;
                spamCountEl.textContent = stats.spam;
                totalCommentsEl.textContent = stats.total;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Show thread (for now just an alert, in real app would navigate to thread)
        function showThread(threadId) {
            alert(`Would navigate to thread: ${threadId}`);
            // In a real implementation: window.location.href = `/thread/${threadId}`;
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleString();
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Helper function to format content (basic markdown support)
        function formatContent(content) {
            if (typeof content !== 'string') return '';
            
            // Basic markdown conversion with XSS prevention
            let html = content;
            
            // Convert newlines to <br>
            html = html.replace(/\n/g, '<br>');
            
            // Convert bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Convert italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // Convert links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            
            // Convert inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Sanitize HTML to prevent XSS (basic implementation)
            const temp = document.createElement('div');
            temp.textContent = html;
            return temp.innerHTML;
        }

        // Logout function
        function logout() {
            // Clear admin key from localStorage
            localStorage.removeItem('adminApiKey');
            
            // Redirect to login or home page
            window.location.href = '../';
        }

        // Expose functions to global scope for inline event handlers
        window.updateCommentStatus = updateCommentStatus;
        window.showThread = showThread;
    </script>
</body>
</html>